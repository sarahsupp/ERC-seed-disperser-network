---
title: "Migration-path.Rmd"
author: "Sarah Supp"
date: "2/10/2020"
output: html_document
---

# INTRODUCTION

## Code for cedar waxwing project, modified from eBird migration project (Supp et al. 2015)
(c) 2020-2023, Niu, Lee, Wisnefski, and Supp (PI)
supps@denison.edu
Denison University
Code is under development, part of NSF Multi-Institution Collaborative Award (2019-2025)
modified from previous code developed for Supp et al. 2015 hummingbird paper (Ecosphere)

Birds evaluated include: 
* Cedar Waxwing (CEWA) _Bombycilla cedrorum_
* Robin (ROBI) _Turdus migratorius_
* Wood Thrush (WOTH) _Hylocichla mustelina_
* Yellow-rumped Warbler (YEWA) _setophaga coronata_
* Blue Jay (BLJA) _Cyanocitta cristata_
* European Starling (EUST) _Sturnus vulgaris_
* Eastern Bluebird (EABL) _Sialia sialis_
* Northern Mockingbird (NOMO) _Mimus polyglottos_
* Downy Woodpecker (DOWO) _Dryobates pubescens_
* Eastern Meadowlark (EAME) _Sturnella magna_
* White-breasted Nuthatch (WHNU) _Sitta carolinensis_
* Purple Finch (PUFI) _Haemorhous purpureus_
* Northern Cardinal (NOCA) _Cardinalis cardinalis_
* Dark-eyed Junco (DAJU) _Junco hyemalis_
* American Crow (AMCR) _Corvus brachyrhynchos_


##FIXME: check which of these libraries is  used, and remove ones that are not needed
```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(broom)
#library(devtools)
#devtools::install_github('r-barnes/dggridR', vignette=TRUE, force = TRUE)
library(dggridR)
library(features)
library(gamm4) 
library(geosphere)
#devtools::install_github("dkahle/ggmap")
library(ggmap)
library(ggpubr)
library(lubridate)
library(maps)
library(mgcv)
library(maptools)
library(purrr)
library(RColorBrewer)
library(sf)
library(viridis)
```

For this code chunk, you need to already have processed the raw eBird data files (process-raw-eBird-data.Rmd) and generated the daily centroids using the nvector method and weighted means (daily-nvector-centroids.Rmd). The second step should have generated these files in the intermediate data folder: dat_effort_filtered.rds, df_nvector.rds, weighted_mean_locs.rds. If you have not yet run these steps or generated the .rds output files, please go back and run those two files in that order first. 

**Note:** dat_effort_filtered.rds and weighted_mean_locs.rds have already been **filtered to the eastern flyway**. [La Sorte et al. 2014](https://onlinelibrary.wiley.com/doi/full/10.1111/jbi.12328) defined western, central, and eastern flyways for migrating songbirds. We use this filter because our species include populations across the continent, and we are focused on eastern and midwestern populations of eastern redcedar. Thus, our processed data excludes western occurrences (<-103 longitude). *If you want to include occurrences from broader locations, will need to use the individual species files generated by the process-eBird-data.Rmd (pre-filtering).*


# Load the processed data 
#### Includes files for: merged species, nvector locations, and the weighted mean daily centroids
These files are generated by the code "daily-nvector-centroid.Rmd".

Loads the processed data
```{r}
# #Loading RDS files for filtered effort, nvector values, and centroids (weighted mean locations)
dat_effort <- readRDS(here("data/2-intermediate_eBird_data/dat_effort_filtered.rds"))
df <- readRDS(here("data/2-intermediate_eBird_data/df_nvector.rds"))
weighted_mean_locs <- readRDS(here("data/2-intermediate_eBird_data/weighted_mean_locs.rds"))
```

# Data summaries for manuscript and annual reporting
Count number of records by year *for NSF report*
```{r}
#count total number of records across the years. (increasing strongly)
counts <- df %>%
  group_by(species, year) %>%
  tally()

num_bins <- ggplot(counts, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of binned observations") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

#checking how many unique grid cells logged an observation in each year (relatively flat)
nPOLYFID <- df %>%
  group_by(species, year) %>%
  summarise(n=n_distinct(POLYFID))

num_gridcells <- ggplot(nPOLYFID, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of unique grid cells") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

#checking how many days per year have at least 1 observation (ALL of them)
nDAYSofyear <- df %>%
  group_by(species, year) %>%
  summarise(n=n_distinct(day))

num_days <- ggplot(nDAYSofyear, aes(year, n)) + geom_bar(stat="identity") + 
  theme_bw() + ylab("Number of unique days per year") + xlab("Year") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~species, ncol=1)

ggarrange(num_bins, num_gridcells, num_days,
          labels=c("A", "B", "C"),
          ncol=3, nrow=1)

ggsave(filename = here("figs/15spp_counts.png"), height = 11, width=8)
```


Initial plot of bird average locations for all species and latitude by day across years *for NSF report*
```{r}
wtlon_by_day <- ggplot(weighted_mean_locs, aes(day, weighted_lon, group=year)) +
  geom_point(alpha=0.25, aes(col=winter)) + geom_line(alpha=0.25) +
  facet_wrap(~year) + 
  theme_bw()

wtlat_by_day <- ggplot(weighted_mean_locs, aes(as.numeric(day), weighted_lat, group=year)) +
  stat_smooth(aes(col=as.numeric(year))) + ylab("Weighted mean latitude") +
  xlab("Day of the year") + 
  scale_x_continuous(breaks = seq(1, 366, by = 60)) +
  facet_wrap(~species) + 
  theme_bw()

ggsave(wtlat_by_day, filename = here("figs/15spp_wtmean_smooth.png"), height = 11, width=8)
```


## Prepares the hexagonal grid cells for later plotting, and summarizes the frequencies by cell
* freq = number of checklists / total effort, per cell
* sum_weighted_count = the sum of all the frequencies within a cell. A proxy for comparing how often target species occur in a given cell.
* mean_weighted_count = the average frequency for a cell. A proxy for how often target species occur in a given cell.

**Note:** the lines using the `dggridr` functions take a few minutes to run.
```{r}
#using the data filtered for eastern flyway (df); and cell centers calculated
dgg <- dgconstruct(project = "FULLER", aperture = 4, topology = "HEXAGON", res = 6)
df$cell <- dgGEO_to_SEQNUM(dgg, df$x, df$y)$seqnum
df$cell_lat <- dgSEQNUM_to_GEO(dgg, df$cell)$lat_deg 
df$cell_lon <- dgSEQNUM_to_GEO(dgg, df$cell)$lon_deg 

#cellcenters   <- dgSEQNUM_to_GEO(dgg, dat_effort$cell)
spp_counts <- df %>%
  group_by(species, cell) %>% 
  summarise(sum_weighted_count=sum(freq),
            mean_weighted_count=mean(freq),
            sum_count=sum(count)) %>%
  ungroup()

ggplot(spp_counts, aes(x=mean_weighted_count)) +
  geom_histogram(binwidth=0.01) + 
  facet_wrap(~species) + 
  theme_bw()

```


## Create a map of eBird effort (all years, all dates) across Eastern North America
This uses the data that has already been filtered to only consider occurrences >=-103 longitude.

For help with dggridR functions, see: https://github.com/r-barnes/dggridR/blob/master/vignettes/dggridR.Rmd. 

```{r}
#Get the grid cell boundaries for cells which had bird observations
grid <- dggridR::dgcellstogrid(dgg, spp_counts$cell) 


#Update the grid cells' properties to include the number of observations in each cell
grid <- merge(grid, spp_counts, by.x="seqnum", by.y="cell")

# #Make adjustments so the output is more visually interesting
#  grid$count    <- log(grid$sum_count)
#  cutoff        <- quantile(grid$count,0.9)
#  grid          <- grid %>% mutate(count=ifelse(count>cutoff,cutoff,count))

#Get polygons for the spatial range and make a map of bird observations
world_map <- map_data("world")
north_america <- world_map %>%
  filter(region %in% c("USA", "Canada", "Mexico", "Guatemala", "Belize", 
                       "El Salvador", "Honduras", "Nicaragua", "Costa Rica", 
                       "Panama"))

# plot the number of checklists submitted (summed) per grid cell (2008-2023)
ggplot() + 
  geom_sf(data = grid, aes(fill = sum_count), color = alpha("white", 0.4 )) +
  geom_polygon(data=north_america, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  scale_fill_gradient(low="grey90", high="black", na.value="white") +
  #scale_fill_gradient(low="red", high="yellow") +
  coord_sf(xlim = c(-103, -60), ylim = c(10, 65)) + #set limits without distorting boundaries
  labs(title = "Number of checklists submitted by grid cell, 2008-2024") +
  theme_minimal() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
  facet_wrap(~species, ncol=5)

ggsave(filename = "figs/15spp_sum_checklist_grids.png", height = 11, width=8)

```

# Estimate migration pathways using Generalized Additive Model, population-level migration speed, and migration dates

## Estimate migration pathway for 15 species each year separately using GAMs
Use GAM model to predict daily location along a smoothing line, from the weighted mean locations. Daily location should be calculated for each year separately.

In the GAM, we can use the weighted mean locations (latitude and longitude) that we have already calculated above. These become the inputs to the gam model, which finds the predicted (smooth) migration path for each day. The predicted (fitted) values become the migration path for the species, which we will then use to estimate start of spring, peak latitude (breeding), and end of autumn migration. Between end Autumn migration and begin of Spring migration, is the expected time that most individual birds are on their wintering grounds and not actively migrating. 


## Creates a dataframe with the daily centroid, estimated from a smoothed GAM fit
**Note:** lat and lon in the resulting dataframe represent the predicted lat and lon from the smoothed line

This code chunk stores a function to use a GAM model to estimate smoothed centroids that represent the migration path. It uses the weighted mean latitude and longitude as inputs and returns new daily centroids based on the predicted model fits, along with lower and upper confidence intervals (LCI, UCI).

In this function, we use parameters as follows: 
* k = 20
* gamma = 1.5

```{r}
Estimatedailylocs = function(dat) {

  years <- unique(dat$year)
  spp <- unique(dat$species)
  
  #initialize empty dataframe
  df_dailylocs <- data.frame(species=character(), day=integer(), year=integer(), 
                             month=integer(), winter=character(), lon=numeric(), 
                             lat=numeric(), lon_se=numeric(), lat_se=numeric(), 
                             lon_LCI=numeric(), lon_UCI=numeric(),
                             lat_LCI=numeric(), lat_UCI=numeric()) 

  for (s in spp){
    for (i in years) {
      sub_weighted_mean_locs <- dat %>%
        filter(year == i & species == s)

      lon_gam = gam(weighted_lon ~ s(day, k=20), data = sub_weighted_mean_locs, gamma = 1.5)
      lat_gam = gam(weighted_lat ~ s(day, k=20), data = sub_weighted_mean_locs, gamma = 1.5)
      xpred = data.frame(day=sort(unique(sub_weighted_mean_locs$day)))
      lonpred = predict(lon_gam, newdata = xpred, type="response", se.fit=T)
      latpred = predict(lat_gam, newdata = xpred, type="response", se.fit=T)
      lon_lowerCI = lonpred$fit - 1.96 * lonpred$se.fit  # Lower bound of 95% CI Longitude centroid
      lon_upperCI = lonpred$fit + 1.96 * lonpred$se.fit  # Upper bound of 95% CI Longitude centroid
      lat_lowerCI = latpred$fit - 1.96 * latpred$se.fit  # Lower bound of 95% CI Latitude centroid
      lat_upperCI = latpred$fit + 1.96 * latpred$se.fit  # Upper bound of 95% CI Latitude centroid

      preds =  data.frame(species = s, day = xpred$day, year = i,
                          month = sub_weighted_mean_locs$month, winter = sub_weighted_mean_locs$winter,
                          lon = lonpred$fit, lat = latpred$fit, lon_se = lonpred$se.fit, 
                          lat_se = latpred$se.fit, lon_LCI = lon_lowerCI, lon_UCI = lon_upperCI,
                          lat_LCI = lat_lowerCI, lat_UCI = lat_upperCI)
      df_dailylocs <- data.frame(bind_rows(df_dailylocs, preds))
    }
  }
  return(df_dailylocs)
}
```

Run the GAM function on the weighted mean dataframe for all species.
```{r}
#get daily centroid locations for all species in all years
dailylocs <- Estimatedailylocs(weighted_mean_locs)

#filter to keep only the migratory species (9 species)
mig_spp_dailylocs <- dailylocs %>% 
  filter (species %in% c("Bombycilla_cedrorum", "Haemorhous_purpureus", 
                         "Hylocichla_mustelina", "Junco_hyemalis", 
                         "Setophaga_coronata", "Turdus_migratorius", 
                         "Sialia_sialis", "Sturnella_magna", 
                         "Sturnus_vulgaris"))
```

Plot results from the GAM model
```{r}
ggplot(mig_spp_dailylocs, aes(x=day, y=lat, group=year)) + 
  geom_point(aes(col=as.factor(year)), size=0.10) + 
  scale_color_viridis(discrete=TRUE, option="magma") + 
  facet_wrap(~species, scales="free") +
  xlab("day of year") + ylab("centroid latitude") + 
  labs(col = "Year") +
  theme_bw()

ggsave(filename = here("figs/9spp_GAMlatitude.png"), height = 6, width=8)
```

Plot GAM model results showing the lat-lon path on a geographic map by species
```{r}

# plot the number of checklists submitted (summed) per grid cell (2008-2024)
ggplot() + 
  geom_polygon(data=north_america, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  coord_sf(xlim = c(-103, -60), ylim = c(15, 55)) + #set limits without distorting boundaries
  geom_point(data=mig_spp_dailylocs, aes(lon, lat, col=winter), size=0.1, alpha=0.1) +
  scale_color_viridis(discrete=TRUE) +
  labs(title = "GAM smoothed migration path, 2008-2024") +
  theme_minimal() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
  theme(legend.position="bottom") +
  guides(color = guide_legend(override.aes = list(size = 3, alpha=1) ) ) +
  facet_wrap(~species, ncol=3)

ggsave(filename = here("figs/9spp_GAMmap.png"), height = 6, width=8)
```

Plot the results of the smoothed daily locations (centroids) for the migratory species by day of year
```{r}
ggplot(mig_spp_dailylocs, aes(day, lat, group=year)) + 
  geom_line(linewidth=0.1, aes(col=winter)) +
  scale_colour_manual(values = c("grey50", "blue")) +
  # Day 91 = April 1; Day 273 = Sep 30
  geom_vline(xintercept=c(91, 273), col="gray30") +
  xlab("Day of Year") + ylab("centroid latitude") +
  facet_wrap( ~species, ncol=3) + 
  theme_bw()

ggsave(filename = here("figs/9spp_GAMlatitude_winter.png"), height = 8, width=8)
```

Plot the results of the smoothed daily locations (centroids) for the migratory species on a map
```{r}
ggplot(mig_spp_dailylocs, aes(lon, lat, group=year)) +
  geom_point(aes(col=winter), alpha=0.25, size=0.1) +
  geom_polygon(data=north_america, aes(x=long, y=lat, group=group), fill=NA, color="black")   +
  coord_sf(xlim = c(-103, -60), ylim = c(10, 65)) + #set limits without distorting boundaries
  scale_colour_manual(values = c("grey50", "blue")) +
  labs(title = "Daily centroids, 2008-2024") +
  theme_minimal() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
  theme(legend.position = "none") +
  facet_wrap(~species, ncol=3)

ggsave(filename = here("figs/9spp_GAMmap_winter.png"), height = 8, width=6)

```

For relevance to ERC, we have labeled the monthts October-March as "winter" (blue). This is the time of year that ERC is fruiting and where it is most important to be eaten and passed through a bird's gut to enhance germination. For each species, we will also need to determine the lat-long of interest, that corresponds to the necessary time of year and falls within the ERC geographic range extent. 


## Find the distances (kilometers) traveled between the mean locations. 
This calculation uses Great Circle (ellipsoid) distance on the estimated daily locations from the GAM model predictions for latitude and longitude. Because of the way the distVicentyEllipsoid function works on the values, the rows *must* all be in chronological order.
All rows must exist, so any days of the year where the species was not recorded in eBird, must be identified and added with NA values.
```{r}
#identify dates with no location and assign all values to NA
missdates <- mig_spp_dailylocs %>%
  group_by(species, year) %>%
  #technically this leaves out DAY 366 in 2008, 2012, 2016, and 2020, but I don't think that matters?
  dplyr::reframe(missing = setdiff(1:365, day)) %>% 
  mutate(day = missing, month=NA, winter=NA, lon=NA, lat=NA, lon_se=NA, lat_se=NA,
         lon_LCI=NA, lon_UCI=NA, lat_LCI=NA, lat_UCI=NA) %>%
  dplyr::select(species, day, year, month, lon, lat, lon_se, lat_se, lon_LCI, lon_UCI, lat_LCI, lat_UCI)

#append the missing/NA date values to the main dailylocs dataframe
mig_spp_dailylocs <- bind_rows(mig_spp_dailylocs, missdates)
```

## Centroid distance moved, as kilometers per day (km/day)
Calculate the km/day moved, as sequential distances each day to day within the year
```{r}
#calculate sequential distances in kilometers using geosphere::distVicentyEllipsoid
#   adds NA for the first record
calc_dist_km <- function(lon, lat) {
  m <- cbind(lon,lat)
  dist <- append(NA, distVincentyEllipsoid(m))/1000
  return(dist)
}

mig_spp_dailylocs <- mig_spp_dailylocs %>%
  #order chronologically by year and day
  arrange(species, year, day) %>% 
  group_by(species, year) %>%
  #calculate sequential distances, adds NA for the first record
  mutate(distance_km = calc_dist_km(lon, lat)) %>%
  #Remove Day 1 for all years; due to our method separating GAM by year, it will be a flawed value
  filter(day != 1)

# saving the migratory species distances traveled to file 
saveRDS(mig_spp_dailylocs, file = here("data/2-intermediate_eBird_data/mig_spp_dailylocs.rds"))
```

Plot the results of the distance calculation
```{r}
dist_by_day <- ggplot(mig_spp_dailylocs, aes(as.numeric(day), distance, group=year)) + 
  geom_line(aes(col=winter), linewidth=0.1) +
  scale_colour_manual(values = c("grey50", "blue")) +
  xlab("Julian Day") + ylab("Distance Traveled (km)") + 
  theme(text = element_text(size=12)) + 
  theme_bw() + 
  theme(legend.position = "none") +
  facet_wrap(~species, ncol=3)
  #geom_vline(xintercept = median(day), col = "indianred", linetype = "dashed")
  #geom_vline(xintercept = median(migr_dates), col = "indianred", linetype = "dashed")
dist_by_day

ggsave(dist_by_day, filename = here("figs/9spp_centroid_dist_km.png"), height = 5, width=8)
```

## Estimate the maximum migration speed during migration 
First, remove all values for Day = 1. Because each GAM was calculated separately by year, distance between Dec 31 and Jan 1 will not be valid. 
Use the median of the top 5 migration speeds for each year separately, as the estimated maximum migration speed (km/day) for the species. 
Report the annual estimates, and an overall summary of the values pooled across years (mean, sd, median, 1st and 3rd quantiles)
```{r}
# Estimate the maximum migration speed for each year (km/day)
# To reduce choosing an extreme value, take the top 5 speeds for each species in each year, and report the median value
 max_speed <- mig_spp_dailylocs %>%
   filter(day != 1) %>%
   group_by(species, year) %>%
   slice_max(order_by=distance, n = 5, with_ties = FALSE) %>%
   summarize(max_speed = median(distance)) %>%
   ungroup()
 
# save the result as an rds file and as a txt file
saveRDS(max_speed, here("data/3-results_data/max_speed.rds"))
write.table(max_speed, here(file = 'data/3-results_data/max_speed_table.txt'), col.names = TRUE,
              row.names = FALSE, sep = "\t")
```

Let's further summarize the max speed for each species across years, to check how much it varies
```{r}
# reports mean, median, and sd across 2008-2022 for each species
max_speed_summary <- max_speed %>%
  group_by(species) %>%
  summarise(
    mean = mean(max_speed),
    sd = sd(max_speed),
    median = median(max_speed),
    Q1 = quantile(max_speed, probs=0.25),
    Q3 = quantile(max_speed, probs=0.75))

# save the result as an rds file and as a txt file
saveRDS(max_speed_summary, here("data/3-results_data/max_speed_summary.rds"))
write.table(max_speed_summary, here(file = 'data/3-results_data/max_speed_summary_table.txt'), col.names = TRUE,
              row.names = FALSE, sep = "\t")
```

Plot the annual maximum migration speeds for the 6 migratory species, with a horizontal line showing the median of all the years for a species pooled together.
```{r}
# plot yearly maximum migration speeds for each species
max_mig_speed_plot <- ggplot(max_speed, aes(year, max_speed, group=species)) + 
  geom_hline(data = max_speed_summary, aes(yintercept = median), color = "indianred") +
  geom_point(data=max_speed) +
  xlab("Year") + ylab("Max Speed (km/day)") + 
  scale_x_continuous(breaks=seq(2008, 2024, 4)) +
  theme_bw() + 
  theme(text = element_text(size=10), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position="bottom") + 
  facet_wrap(~species)
max_mig_speed_plot

ggsave(max_mig_speed_plot, filename = here("figs/9spp_MedMaxMigrationSpeed.png"), height = 5, width=8)
```

#make the same plot as above but focus on the 6 migratory species only
```{r}
mig6 <- c("Bombycilla_cedrorum", "Haemorhous_purpureus",
          "Hylocichla_mustelina", "Junco_hyemalis", 
          "Setophaga_coronata","Turdus_migratorius")

ms6 <- max_speed %>% filter(species %in% mig6)
mss6 <- max_speed_summary %>% filter(species %in% mig6)

# plot yearly maximum migration speeds for each species
max_mig_speed_plot <- ggplot(ms6, aes(year, max_speed, group=species)) + 
  geom_hline(data = mss6, aes(yintercept = median), color = "indianred") +
  geom_point(data=ms6) +
  xlab("Year") + ylab("Max Speed (km/day)") + 
  scale_x_continuous(breaks=seq(2008, 2024, 4)) +
  theme_bw() + 
  theme(text = element_text(size=10), 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position="bottom") + 
  facet_wrap(~species)
max_mig_speed_plot

ggsave(max_mig_speed_plot, filename = here("figs/6spp_MedMaxMigrationSpeed.png"), height = 5, width=8)
```



# estimate 3 migration dates, beginning of spring, peak latitude (summer), end of fall migration
This will need some editing to work on each year separately. Ideally a resulting data frame with columns for year, begin_spring, peak_latitude, end_autumn

```{r}
# modified from old function Est3MigrationDates in migration-fxns.R
Est3MigrationDates = function(dat){
  #takes in predicted centroids for migration path, and estimates the beginning of spring migration,
  # the end of fall migration, and the date where the species reaches maximum latitude.
  dat <- dat %>% filter(day != 1)
  year <- c(2008:2024)
  species <- unique(dat$species)
  df_dates <- data.frame(species=character(), year=integer(), spring=numeric(), maxlat=numeric(), fall=numeric()) #initialize empty dataframe
  
  for (s in species) {
    for (y in year){
      #subset data tos pecies and year, remove rows with missing longitude
      dat_subset <- dat %>% filter(species == s, year == y, !is.na(lon))
    print(paste0("species: ", s, "; year: ", y))
    
    #GAM model on latitude by julian date (estimate centroids)
    gam1 = gam(lat ~ s(day, k = 40), data = dat, gamma = 1.5) #FIX ME: Why k=40  and not k=20?
    xpred = data.frame(day = c(1:max(dat$day)))
    dpred = predict(gam1, newdata=xpred, type="response", se.fit=TRUE)
    
    #NOTE: These dates are seeking Jan 1-May 31 for Spring migration begin
    #                 AND          Aug 1-Dec 30 for Fall migration end 
    spring_threshold = min(filter(dat_subset, day %in% c(2:120))$lat_se*2.56 + 
                             filter(dat_subset, day %in% c(2:120))$lat, na.rm=TRUE) # Jan 2 ~ April 30
    fall_threshold = min(filter(dat_subset, day %in% c(244:364))$lat_se*2.56 + 
                           filter(dat_subset, day %in% c(244:364))$lat, na.rm=TRUE) # Sep 1 ~ Dec 30
    
    # Note: After removing DAY=1, there are years with 364 days and with 365 days. 
    #   In effect, the calculation is ignoring the last day of leap years, 
    #   but this should not significantly influence the fall threshold.
    
    ## cutoff based on 2 SE for spring and fall combined, following La Sorte et al. 2013 methods
    # Spring migration should be between 11 Jan and 9 July
    # Fall migration should be between 8 August and 21 Dec
    
    spring_index = intersect(c(11:190), dat_subset$day) # between 11 Jan and 9 July 
    fall_index = intersect(c(220:355), dat_subset$day) # between 8 August and 21 Dec
    spring_max = (dat_subset %>% filter(day %in% spring_index) %>% slice_max(lat))$day
    fall_max =  (dat_subset %>% filter(day %in% fall_index) %>% slice_max(lat))$day
    
    #identify beginning of spring migration
    tst = 1000
    spring_index2 = spring_max
    while(tst > spring_threshold){
      if(nrow(filter(dat_subset, day==spring_index2))>0) {
        tst = filter(dat_subset, day %in% spring_index2)$lat
        if(spring_index2 == 1) break #see if we have to put 2 
        spring_index2 = spring_index2 - 1
      }
      else { spring_index2 = spring_index2 - 1 }
    }
    spring_begin = spring_index2 + 1
    
    #identify end of fall migration
    tst <- 1000
    fall_index2 = fall_max
    while(tst > fall_threshold){
     # print(paste0("tst= ", tst, " fall_index2= ", fall_index2))
      if(nrow(filter(dat_subset, day==fall_index2))>0) {
        tst = filter(dat_subset, day==fall_index2)$lat
        if(fall_index2 == 1) break
        fall_index2 = fall_index2 + 1
      }
      else { fall_index2 = fall_index2 + 1 }
    }
    fall_end <- fall_index2 - 1
    
    # find center of the season, max latitude (e.g. population no longer moving north; breeding)
    max_lat = dat_subset[dat_subset$lat == max(dat_subset$lat),]$day
    dates = data.frame(species = s, year = y, spring = spring_begin, maxlat = max_lat, fall = fall_end)
    df_dates <- data.frame(bind_rows(df_dates, dates))
    }
  }
return(df_dates)
}
```


Run the estimate dates function with the migratory species, removing the partial migrants (method won't work and results won't make sense if there's not a clear breeding season max latitude and clear northward and southward migration movements).
Save the results to an rds file and a text file for later use.
```{r}
#test function
Sys.time()
#remove partial migrants
dailylocs <- mig_spp_dailylocs %>% filter(!species %in% c("Sialia_sialis", "Sturnella_magna", "Sturnus_vulgaris"))
migration_dates <- Est3MigrationDates(dailylocs)
Sys.time()

# save result as an rds and text file
saveRDS(migration_dates, file=here("data/3-results_data/migration_dates.rds"))
write.table(migration_dates, here(file = 'data/3-results_data/migration_dates.txt'), col.names = TRUE,
              row.names = FALSE, sep = "\t")
```



Calculate the median migration date for each species, across all the years
```{r}
#Calculate median migration date for each species
median_migdates <- migration_dates %>%
  group_by(species) %>%
  summarise(begin_spring = median(spring),
            end_autumn = median(fall),
            )

write.table(median_migdates, here(file = 'data/3-results_data/median_migration_dates.txt'), col.names = TRUE,
              row.names = FALSE, sep = "\t")
```

Visualize the estimated dates for the 6 migratory species
```{r}
#set winter dates based on the ERC fruiting season of October-March
end_winter = 90 #March 31
begin_winter = 274 #October 1

spring <- ggscatter(data=migration_dates, x="year", y="spring", facet.by="species", add="reg.line") +
  stat_cor(label.y = 10, aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
  stat_regline_equation(label.y = -10) + 
  geom_hline(yintercept = end_winter, linetype="dashed", col="cadetblue3") +
  theme(text = element_text(size=9), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks=seq(2008, 2024, 6)) +
  xlab("Year") + ylab("spring migration begin date") +
  theme_bw()

autumn <- ggscatter(data=migration_dates, x="year", y="fall", facet.by="species", add="reg.line") +
  stat_cor(label.y = 300, aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
  stat_regline_equation(label.y = 285) + 
  geom_hline(yintercept = begin_winter, linetype="dashed", col="cadetblue3") +
  theme(text = element_text(size=9), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks=seq(2008, 2024, 6)) +
  xlab("Year") + ylab("autumn migration end date") + 
  theme_bw()# 

ggarrange(spring, autumn,
          ncol=1, nrow=2)

ggsave(filename = here("figs/6spp_migration_dates.png"), height = 10, width=7.5)
```

# Statistically compare migration paths, speeds, and dates across the time-series for each species

Look at linear trends for dates of the migratory species to see if there is a significant directional trend, or not.
```{r}
# Function to extract relevant statistics from linear regression object, using tidy models
extract_lm_stats <- function(model) {
  summary_model <- summary(model)
  
  tidy_model <- broom::tidy(model, conf.int=TRUE) %>% 
    filter(term == "year")
  
  tibble(r2 = summary_model$r.squared,
    estimate = tidy_model$estimate,
    conf_low = tidy_model$conf.low,
    conf_high = tidy_model$conf.high,
    pvalue = tidy_model$p.value)
}

# Process each species for spring and autumn, separately
date_results <- migration_dates %>%
  group_by(species) %>%
  nest() %>%
  mutate(
    spring_lm = purrr::map(data, ~lm(spring ~ year, data = .x)),
    fall_lm = purrr::map(data, ~lm(fall ~ year, data = .x)),
    spring_stats = purrr::map(spring_lm, extract_lm_stats),
    fall_stats = purrr::map(fall_lm, extract_lm_stats)
  ) %>%
  select(-spring_lm, -fall_lm, -data) %>%
 unnest(cols = c(spring_stats, fall_stats), names_sep = "_")

# View results
date_results

# view only significant results
date_results %>% filter(spring_stats_pvalue < 0.05 | fall_stats_pvalue < 0.05)

# write to results file
write.table(date_results, here(file = 'data/3-results_data/lm_migration_dates.txt'), col.names = TRUE,
              row.names = FALSE, sep = "\t")
```


Plot results from the GAM model with the estimated dates 
Save to file
```{r}
ggplot(mig_spp_dailylocs, aes(x=day, y=lat, group=year)) + 
  geom_point(aes(col=as.factor(year)), size=0.10) + 
  scale_color_viridis(discrete=TRUE, option="magma") + 
  geom_vline(data=migration_dates, aes(xintercept=spring), col="skyblue") + 
  geom_vline(data=migration_dates, aes(xintercept=fall), col="darkorange3") +
#  geom_vline(data=migration_dates, aes(xintercept=maxlat, col="grey50")) +
  facet_wrap(~species, scales="free") +
  xlab("day of year") + ylab("centroid latitude") + 
  labs(col = "Year") +
  theme_bw()

ggsave(filename = here("figs/9spp_lat_with_dates.png"), height = 6, width=8)
```

